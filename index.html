<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>오늘의 자기기록</title>
    <style>
        /* 폰트 및 기본 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --primary-color: #6a7ba2; /* 주요 색상: 네이비 */
            --secondary-color: #7ec8e3; /* 보조 색상: 스카이블루 */
            --background-color: #f8f8fa; /* 배경색 */
            --card-background: #FFFFFF;
            --text-color: #333;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 900px; /* 전체 너비 확장 */
            margin: 40px auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* 폼 섹션 스타일 */
        #record-form {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        input[type="text"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
            box-sizing: border-box;
        }
        
        .hint {
            font-size: 0.8rem;
            color: #999;
            margin-top: 5px;
        }

        /* 기분 선택 버튼 스타일 */
        .mood-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .mood-selector input[type="radio"] {
            display: none;
        }

        .mood-selector label {
            padding: 10px 18px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 500;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .mood-selector input[type="radio"]:checked + label {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            font-weight: 700;
            transform: scale(1.05);
        }

        button[type="submit"] {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover {
            background-color: #55668c;
        }

        /* 📝 기록 목록 섹션 (표 스타일) */
        .records-section {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .records-section h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.5em;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #export-excel {
            padding: 8px 15px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        /* 표 그리드 레이아웃 */
        .records-header, .record-row {
            display: grid;
            /* 닉네임/점수/기분/단어/요약/칭찬/도움 */
            grid-template-columns: 80px 50px 80px 100px 1fr 1fr 1fr;
            gap: 5px;
            padding: 10px 5px;
            align-items: center;
            font-size: 0.85rem;
        }

        .records-header {
            font-weight: 700;
            background-color: #f0f0ff; /* 헤더 배경색 */
            border-bottom: 2px solid var(--primary-color);
            border-top: 2px solid var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .record-row {
            border-bottom: 1px dashed var(--border-color);
        }

        .record-row:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .record-row:hover {
            background-color: #eef2f9;
        }

        .records-header > div, .record-row > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 5px;
        }
        
        /* 닉네임, 점수, 기분은 중앙 정렬 */
        .record-row .record-nickname,
        .record-row .record-score,
        .record-row .record-mood {
            text-align: center;
        }

        .record-row .record-mood {
            font-size: 1.2rem;
        }


        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: #757575;
        }

        /* 모바일 반응형 (표를 카드로 변환) */
        @media (max-width: 600px) {
            .records-header {
                display: none;
            }
            .record-row {
                grid-template-columns: 1fr;
                gap: 5px;
                margin-bottom: 15px;
                padding: 15px;
                border: 1px solid var(--border-color);
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }
            .record-row > div {
                white-space: normal;
                padding: 0;
            }
            .record-row > div::before {
                content: attr(data-label) ": ";
                font-weight: bold;
                color: var(--primary-color);
                margin-right: 5px;
            }
            .record-summary, .record-praise, .record-helpful {
                 /* 긴 텍스트는 폰트 크기를 조금 줄여 가독성 확보 */
                font-size: 0.9rem; 
            }
            /* 모바일에서 버튼이 겹치지 않도록 */
            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>나의 하루 리포트</h1>
            <p>오늘의 나를 객관적·감정적으로 기록해보세요.</p>
        </header>

        <main>
            <form id="record-form">
                <!-- 1. 오늘의 칭찬 점수 -->
                <div class="form-group">
                    <label for="score">1️⃣ 오늘의 나의 칭찬 점수는?</label>
                    <select id="score" name="score" required>
                        <option value="">점수를 선택하세요</option>
                        <!-- 점수 옵션이 스크립트로 생성됩니다 -->
                    </select>
                </div>

                <!-- 2. 오늘의 기분 -->
                <div class="form-group">
                    <label>2️⃣ 오늘의 나의 기분은?</label>
                    <div class="mood-selector">
                        <input type="radio" id="mood1" name="mood" value="편안" checked/>
                        <label for="mood1">😌 편안</label>

                        <input type="radio" id="mood2" name="mood" value="기쁨" />
                        <label for="mood2">☺️ 기쁨</label>

                        <input type="radio" id="mood3" name="mood" value="보통" />
                        <label for="mood3">🫤 보통</label>

                        <input type="radio" id="mood4" name="mood" value="화남" />
                        <label for="mood4">😤 화남</label>

                        <input type="radio" id="mood5" name="mood" value="슬픔" />
                        <label for="mood5">😢 슬픔</label>
                    </div>
                    <p class="hint">※ 점수(1번)는 ‘이성적 평가’, 기분은 ‘감정적 상태’를 표현합니다.</p>
                </div>

                <!-- 3. 오늘의 단어 -->
                <div class="form-group">
                    <label for="word">3️⃣ 오늘 하루를 나타내는 단어 하나</label>
                    <input
                        type="text"
                        id="word"
                        name="word"
                        maxlength="20"
                        placeholder="예: 차분함, 성취감, 지침"
                        required
                    />
                </div>

                <!-- 4. 오늘의 한 줄 요약 -->
                <div class="form-group">
                    <label for="summary">4️⃣ 오늘 나에 대한 한 줄 요약</label>
                    <input
                        type="text"
                        id="summary"
                        name="summary"
                        maxlength="30"
                        placeholder="예: 오늘도 괜찮았어"
                        required
                    />
                </div>

                <!-- 5. 칭찬과 격려 -->
                <div class="form-group">
                    <label for="praise">5️⃣ 오늘의 나에게 해주고 싶은 칭찬과 격려 한마디</label>
                    <textarea
                        id="praise"
                        name="praise"
                        rows="3"
                        placeholder="오늘 내가 잘한 점은 ___이다."
                    ></textarea>
                </div>

                <!-- 6. 도움이 되었던 행동/생각 -->
                <div class="form-group">
                    <label for="helpful">6️⃣ 나에게 도움이 되었던 행동이나 생각이 있다면 공유해 주세요</label>
                    <textarea
                        id="helpful"
                        name="helpful"
                        rows="3"
                        placeholder="예: 산책하면서 머리가 맑아졌어요."
                    ></textarea>
                </div>

                <!-- 7. 닉네임 -->
                <div class="form-group">
                    <label for="nickname">7️⃣ 닉네임을 입력해주세요</label>
                    <input
                        type="text"
                        id="nickname"
                        name="nickname"
                        maxlength="10"
                        placeholder="예: 익명의 학생"
                        required
                    />
                </div>

                <button type="submit">기록하기</button>
            </form>

            <!-- 📝 기록 목록 섹션 -->
            <section class="records-section">
                <div class="section-header">
                    <h2>우리의 기록들</h2>
                    <button id="export-excel">엑셀로 내보내기</button>
                </div>
                <div class="records-list-container">
                    <!-- 표 헤더 (Apps Script의 헤더 순서와 일치하도록 배치됨) -->
                    <div class="records-header">
                        <div>닉네임</div>
                        <div>점수</div>
                        <div>기분</div>
                        <div>단어</div>
                        <div>요약</div>
                        <div>칭찬/격려</div>
                        <div>도움된점</div>
                    </div>
                    <div id="records-container">
                        <!-- 기록 목록이 여기에 동적으로 추가됩니다. -->
                    </div>
                </div>
            </section>

        </main>

        <footer>
            <p>&copy; 2025 나의 하루 리포트. All rights reserved.</p>
        </footer>
    </div>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ✅ 최종 배포 URL 반영
            // 이 부분을 새로 배포한 Apps Script URL로 변경해 주세요!
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzOR6HRKpg3cucLcjAChGDkvOSUigb0vwASeRlhbVseSedcT6KxtXLXhSKTmVkqNepX/exec'; 

            // 10점부터 100점까지의 옵션 추가 (스크립트로 생성)
            const scoreSelect = document.getElementById('score');
            
            // 기존의 for 루프와 수동 옵션을 제거하고, 10부터 100까지 10점 단위로 모두 생성합니다.
            for (let i = 10; i <= 100; i += 10) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}점`;
                scoreSelect.appendChild(option);
            }
            
            const recordForm = document.getElementById('record-form');
            const recordsContainer = document.getElementById('records-container');
            const exportButton = document.getElementById('export-excel');
            let recordsCache = []; // 데이터 캐싱

            // DOM에 기록 목록 행 추가
            const addRecordToDOM = (record) => {
                const row = document.createElement('div');
                row.classList.add('record-row');

                const moodEmojis = { 
                    '편안': '😌', '기쁨': '☺️', '보통': '🫤', '화남': '😤', '슬픔': '😢' 
                };
                
                // Apps Script의 헤더와 일치하는 키 사용 (대문자 주의: Nickname, Score, Mood 등)
                row.innerHTML = `
                    <div class="record-nickname" data-label="닉네임">${record.Nickname || ''}</div>
                    <div class="record-score" data-label="점수">${record.Score || ''}</div>
                    <div class="record-mood" data-label="기분">${moodEmojis[record.Mood] || record.Mood || ''}</div>
                    <div class="record-word" data-label="단어" title="${record.Word || ''}">${record.Word || ''}</div>
                    <div class="record-summary" data-label="요약" title="${record.Summary || ''}">${record.Summary || ''}</div>
                    <div class="record-praise" data-label="칭찬/격려" title="${record.Praise || ''}">${record.Praise || ''}</div>
                    <div class="record-helpful" data-label="도움된점" title="${record.Helpful || ''}">${record.Helpful || ''}</div>
                `;
                recordsContainer.prepend(row); // 최신 항목을 가장 위에 추가
            };

            // 데이터 로드 및 화면 업데이트
            const loadRecords = async () => {
                recordsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">데이터를 불러오는 중...</div>';
                try {
                    const response = await fetch(WEB_APP_URL, { method: 'GET' });
                    
                    if (!response.ok) {
                         const errorText = await response.text();
                         console.error("Apps Script Error Response:", errorText);
                         throw new Error(`데이터 로드 실패: ${response.statusText}`);
                    }
                    
                    recordsCache = await response.json();

                    if (!Array.isArray(recordsCache)) {
                        console.error("Error data received:", recordsCache);
                        throw new Error('Google Apps Script에서 유효하지 않은 데이터가 수신되었습니다. 시트/헤더 설정을 확인하세요.');
                    }
                    
                    // Timestamp 기준으로 최신순 정렬
                    // Apps Script에서 첫 번째 헤더가 "Timestamp" (대문자 T)인지 확인하세요.
                    recordsCache.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                    
                    recordsContainer.innerHTML = ''; 
                    if (recordsCache.length === 0) {
                         recordsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #777;">아직 기록된 내용이 없습니다.</div>';
                    } else {
                        recordsCache.forEach(addRecordToDOM);
                    }

                } catch (error) {
                    console.error('Error loading records:', error);
                    // 오류 메시지 창 대신 인라인 메시지로 표시
                    const errorMessage = error.message.includes('Sheet not found') 
                        ? '⚠️ 시트 이름을 확인하거나 스프레드시트 접근 권한을 확인하세요.' 
                        : `데이터 로드 실패: ${error.message}`;

                    recordsContainer.innerHTML = `<div style="color: red; padding: 20px; text-align: center;">${errorMessage}</div>`;
                }
            };

            // 폼 제출 이벤트 처리
            recordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = '저장 중...';

                const formData = new FormData(recordForm);
                // POST 데이터의 키는 Apps Script의 doPost 함수 내부 변수명과 일치해야 합니다.
                const data = {
                    score: formData.get('score'),
                    mood: formData.get('mood'),
                    word: formData.get('word'),
                    summary: formData.get('summary'),
                    praise: formData.get('praise'),
                    helpful: formData.get('helpful'),
                    nickname: formData.get('nickname')
                };

                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Apps Script에서 오류 응답을 받았습니다. (HTTP 상태 코드 오류)');
                    }

                    const result = await response.json();
                    if (result.status === 'error') {
                         throw new Error(result.message);
                    }
                    
                    // 성공 메시지 로그 출력
                    console.log('✅ 성공적으로 기록되었습니다. 데이터를 새로고침합니다.', result);
                    
                    recordForm.reset();
                    document.getElementById('mood1').checked = true; // 기분 초기화

                    // 데이터 캐시 및 목록 새로고침 (서버에서 최신 데이터 로드)
                    loadRecords(); 

                } catch (error) {
                    console.error('Error submitting record:', error);
                    // alert() 대신 커스텀 메시지 사용
                    const errorMessage = `❌ 기록 저장에 실패했습니다. Apps Script의 로그를 확인하세요. (${error.message})`;
                    alert(errorMessage); 
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '기록하기';
                }
            });

            // 엑셀 내보내기 이벤트 처리
            exportButton.addEventListener('click', () => {
                if (recordsCache.length === 0) {
                    alert('내보낼 데이터가 없습니다.');
                    return;
                }
                
                // 내보낼 필드 순서와 한글 헤더 정의
                const exportData = recordsCache.map(record => {
                    return {
                        '기록시간': record.Timestamp, // Apps Script에서 가져온 데이터 키를 사용
                        '닉네임': record.Nickname,
                        '점수': record.Score,
                        '기분': record.Mood,
                        '단어': record.Word,
                        '요약': record.Summary,
                        '칭찬/격려': record.Praise,
                        '도움된점': record.Helpful
                    };
                }).filter(r => r['점수'] !== undefined); // 데이터가 있는 유효한 행만 내보내기

                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "칭찬기록");
                XLSX.writeFile(workbook, "my_praise_records.xlsx");
            });

            // 초기 데이터 로드
            loadRecords();
        });
    </script>
</body>
</html>
